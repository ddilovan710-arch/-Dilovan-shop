<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family:"Cairo",sans-serif; margin:0; background:#0f172a; color:#e2e8f0; direction:rtl; font-size:18px; }
    header { background:#0b1223; color:#fff; padding:22px; text-align:center; font-size:26px; position:sticky; top:0; z-index:5; }
    nav { display:flex; justify-content:center; gap:14px; background:#111a33; padding:14px; flex-wrap:wrap; }
    nav button { background:#0ea5e9; border:none; color:white; padding:16px 26px; border-radius:12px; cursor:pointer; font-size:20px; font-weight:bold; }
    nav button:hover { background:#0284c7; }
    section { display:none; max-width:1000px; margin:24px auto; background:#0b1223; padding:22px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    section.active { display:block; }
    label { display:block; margin-top:12px; font-weight:700; font-size:18px; }
    input,button,select { margin:8px 0; padding:14px; border-radius:10px; border:1px solid #334155; width:100%; box-sizing:border-box; font-size:18px; background:#0f172a; color:#e2e8f0; }
    input::placeholder { color:#94a3b8; }
    button.action { background:#22c55e; color:white; border:none; width:100%; font-size:20px; font-weight:800; }
    button.action:hover { background:#16a34a; }
    .btn-sm { padding:10px 14px; font-size:16px; border-radius:10px; cursor:pointer; }
    .edit { background:#f59e0b; color:white; border:none; }
    .delete { background:#ef4444; color:white; border:none; }
    .neutral { background:#334155; color:#e2e8f0; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:16px; font-size:16px; }
    th,td { border:1px solid #1f2937; padding:10px; text-align:center; }
    th { background:#0f172a; }
    .searchBox{ margin:8px 0 14px; display:flex; gap:8px; flex-wrap:wrap; }
    .searchBox input{ flex:1; }

    /* ===== Scanner box ===== */
    #scanner { display:none; margin:15px auto; width:320px; height:320px; position:relative; border-radius:12px; overflow:hidden; background:#000; }
    .scan-box{ position:absolute; width:86%; height:32%; left:7%; top:34%; border:3px solid #00e5ff; border-radius:10px; pointer-events:none; }
    .scan-line{ position:absolute; left:8%; width:84%; height:2px; background:#ff3b3b; box-shadow:0 0 8px #ff3b3b,0 0 16px #ff3b3b; animation:sweep 1.3s linear infinite; }
    @keyframes sweep{ 0%{ top:36%; } 100%{ top:64%; } }
    #lastScan { text-align:center; font-size:18px; margin-top:8px; font-weight:bold; color:#93c5fd; }

    /* ===== Modal (Ù†Ø¸Ø§Ù…ÙŠ) ===== */
    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:999;
    }
    .modal.open{ opacity:1; pointer-events:auto; }
    .modal__dialog{
      width:min(92vw, 420px); background:#0b1223; border:1px solid #1f2937;
      border-radius:14px; padding:20px; transform:translateY(10px) scale(.98);
      transition:transform .2s ease; box-shadow:0 16px 36px rgba(0,0,0,.35); text-align:center;
    }
    .modal.open .modal__dialog{ transform:translateY(0) scale(1); }
  </style>
</head>
<body>
  <header>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</header>

  <nav>
    <button onclick="showPage('sell')">ğŸ’µ Ø§Ù„Ø¨ÙŠØ¹</button>
    <button onclick="showPage('products')">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button onclick="showPage('profit')">ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</button>
    <button onclick="showPage('history')">ğŸ“Š Ø§Ù„Ø³Ø¬Ù„</button>
  </nav>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
  <section id="sell" class="active">
    <h2>ğŸ’µ Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙ‚Ø·)">
      <button class="btn-sm neutral" onclick="startScanner('search')">ğŸ“· Ù…Ø³Ø­</button>
      <button class="btn-sm neutral" onclick="searchPage()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
    <div id="searchResult"></div>

    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="sellBarcode" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button class="btn-sm neutral" onclick="startScanner('sell')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>

    <button class="action" onclick="showSellModal()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹</button>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <section id="products">
    <h2>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ø¹Ø±+Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)">
      <button class="btn-sm neutral" onclick="startScanner('search')">ğŸ“· Ù…Ø³Ø­</button>
      <button class="btn-sm neutral" onclick="searchPage()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
    <div id="searchResult"></div>

    <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
    <input id="pprice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©">

    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="pbarcode" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button class="btn-sm neutral" onclick="startScanner('product')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>

    <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
    <input id="pstock" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">

    <button class="action" onclick="addOrUpdateProduct()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>

    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± (ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) -->
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="openIO('import','products')">ğŸ“¦ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn-sm" style="background:#f97316; color:#fff; border:none;" onclick="openIO('export','products')">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
    </div>

    <h2 style="margin-top:18px;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <p>ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ù„Ø¨Ø¶Ø§Ø¹Ø©: <span id="inventoryValue">0</span></p>

    <table id="productsTable">
      <thead><tr><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø±Ø¨Ø­ (Ø¨Ø¯ÙˆÙ† Ø¨Ø­Ø«) -->
  <section id="profit">
    <h2>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h2>
    <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalSales">0</span></p>
    <p>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="totalCost">0</span></p>
    <p>âœ… ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="netProfit">0</span></p>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„ -->
  <section id="history">
    <h2>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø³Ø¬Ù„: ÙŠØ¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø§Ù„ØªØµØ¯ÙŠØ±)">
      <button class="btn-sm neutral" onclick="startScanner('search')">ğŸ“· Ù…Ø³Ø­</button>
      <button class="btn-sm neutral" onclick="searchPage()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
    <div id="searchResult"></div>

    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± (ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ ÙÙ‚Ø· ØªØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©) -->
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="openIO('import','history')">ğŸ“¦ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn-sm" style="background:#f97316; color:#fff; border:none;" onclick="openIO('export','history')">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
    </div>

    <table id="historyTable">
      <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
  <div id="sellModal" class="modal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="sellTitle">
      <h3 id="sellTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ğŸ›’</h3>
      <p id="sellInfo"></p>
      <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
      <input id="modalSellPrice" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
      <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
      <input id="modalSellQty" type="number" value="1">
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="confirmSale()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹</button>
        <button class="btn-sm danger" data-close>âŒ Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <div id="ioModal" class="modal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ioTitle">
      <h3 id="ioTitle">ğŸ“¦ Ø¹Ù…Ù„ÙŠØ©</h3>
      <input id="ioMode" type="hidden" value="import">
      <input id="ioSource" type="hidden" value="products">
      <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
      <input id="ioBarcode" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
      <button class="btn-sm neutral" onclick="startScanner('io')">ğŸ“· Ù…Ø³Ø­</button>
      <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
      <input id="ioQty" type="number" value="1">
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="processIO()">âœ… Ø­ÙØ¸</button>
        <button class="btn-sm danger" data-close>âŒ Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
  <div id="scanner">
    <div class="scan-box"><div class="scan-line"></div></div>
  </div>
  <div id="lastScan"></div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    /* ====== Ø¨ÙŠØ§Ù†Ø§Øª ====== */
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
    let scannerMode = null;

    function saveData(){
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    /* ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ====== */
    function loadProducts(){
      const tbody=document.querySelector("#productsTable tbody");
      tbody.innerHTML=""; let total=0;
      products.forEach(p=>{
        tbody.innerHTML += `<tr>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn-sm edit" onclick="editProduct('${p.barcode}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn-sm delete" onclick="deleteProduct('${p.barcode}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        </tr>`;
        total += (Number(p.price)||0) * (Number(p.stock)||0);
      });
      document.getElementById("inventoryValue").textContent = total.toFixed(2);
    }

    function loadHistory(){
      const tbody=document.querySelector("#historyTable tbody");
      tbody.innerHTML="";
      transactions.forEach(t=>{
        tbody.innerHTML += `<tr>
          <td>${t.type}</td><td>${t.barcode}</td><td>${t.qty}</td>
          <td>${t.price}</td><td>${t.total}</td><td>${t.date}</td>
        </tr>`;
      });
    }

    /* ====== CRUD Ù…Ù†ØªØ¬Ø§Øª ====== */
    function addOrUpdateProduct(){
      const price=parseFloat(document.getElementById("pprice").value)||0;
      const barcode=document.getElementById("pbarcode").value.trim();
      const stock=parseInt(document.getElementById("pstock").value)||0;
      if(!barcode) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");

      let p=products.find(x=>x.barcode===barcode);
      if(p){ p.price = price || p.price; p.stock += stock; }
      else { products.push({barcode, price, stock}); }
      saveData(); loadProducts();
      alert("âœ” ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function editProduct(b){
      let p=products.find(x=>x.barcode===b);
      if(!p) return;
      document.getElementById("pbarcode").value=p.barcode;
      document.getElementById("pprice").value=p.price;
      document.getElementById("pstock").value=p.stock;
      showPage("products");
    }

    function deleteProduct(b){
      products = products.filter(p=>p.barcode!==b);
      saveData(); loadProducts();
    }

    /* ====== Ø¨ÙŠØ¹ ====== */
    function recordTransaction(b,q,pr){
      let p=products.find(x=>x.barcode===b)||{price:0};
      transactions.push({
        type:"Ø¨ÙŠØ¹", barcode:b, qty:q,
        price:pr, total:pr*q, cost:(Number(p.price)||0)*q,
        date:new Date().toLocaleString()
      });
      saveData();
    }

    function showSellModal(){
      const b=document.getElementById("sellBarcode").value.trim();
      let p=products.find(x=>x.barcode===b);
      if(!p) return alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      document.getElementById("sellInfo").innerHTML =
        `Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${p.barcode}<br>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${p.stock}<br>Ø§Ù„ØªÙƒÙ„ÙØ©: ${p.price}`;
      openModal('sellModal');
    }

    function confirmSale(){
      const b=document.getElementById("sellBarcode").value.trim();
      const q=parseInt(document.getElementById("modalSellQty").value)||0;
      const pr=parseFloat(document.getElementById("modalSellPrice").value)||0;
      let p=products.find(x=>x.barcode===b);
      if(!p) return alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      if(q<=0 || pr<0) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");
      if(p.stock < q) return alert("âŒ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ");
      p.stock -= q;
      recordTransaction(b,q,pr);
      saveData(); loadProducts(); loadHistory();
      closeModal('sellModal');
      alert("âœ” ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹");
    }

    /* ====== Ø±Ø¨Ø­ ====== */
    function calcProfit(){
      let s=0,c=0;
      transactions.forEach(t=>{ s += (Number(t.price)||0) * (Number(t.qty)||0); c += (Number(t.cost)||0); });
      document.getElementById("totalSales").textContent=s.toFixed(2);
      document.getElementById("totalCost").textContent=c.toFixed(2);
      document.getElementById("netProfit").textContent=(s-c).toFixed(2);
    }

    /* ====== ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª ====== */
    function showPage(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(id==="products") loadProducts();
      if(id==="history") loadHistory();
      if(id==="profit") calcProfit();
      // ØªÙØ±ÙŠØº ØµÙ†Ø¯ÙˆÙ‚ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
      const sr = document.getElementById("searchResult");
      if(sr) sr.innerHTML = "";
    }

    /* ====== Ø¨Ø­Ø« (Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©) ====== */
    function searchPage(){
      const input = document.getElementById("searchInput");
      if(!input) return;
      const code=input.value.trim(); if(!code) return;
      const active=document.querySelector("section.active").id;
      let res="";

      if(active==="sell"){
        const p=products.find(x=>x.barcode===code);
        res = p ? `Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­: <b>${p.stock}</b> (Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°)` : "âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
      }
      if(active==="products"){
        const p=products.find(x=>x.barcode===code);
        res = p ? `âœ… Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: <b>${p.barcode}</b> â€¢ Ø§Ù„ØªÙƒÙ„ÙØ©: <b>${p.price}</b> â€¢ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: <b>${p.stock}</b>` : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
      }
      if(active==="history"){
        const logs=transactions.filter(t=>t.barcode===code);
        res = logs.length ? logs.map(t=>`${t.type} â€¢ ÙƒÙ…ÙŠØ© ${t.qty} â€¢ Ø¨ØªØ§Ø±ÙŠØ® ${t.date}`).join("<br>") : "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª";
      }
      document.getElementById("searchResult").innerHTML=res;
    }

    /* ====== Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± ====== */
    function openIO(mode, src){
      // mode: 'import' | 'export'  â€”  src: 'products' | 'history'
      document.getElementById('ioMode').value = mode;
      document.getElementById('ioSource').value = src;
      document.getElementById('ioTitle').textContent = (mode==='import'?'ğŸ“¦ Ø§Ø³ØªÙŠØ±Ø§Ø¯':'ğŸ“¤ ØªØµØ¯ÙŠØ±')
        + (src==='products'?' (ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®Ø²ÙˆÙ†)':' (ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·)');
      document.getElementById('ioBarcode').value = '';
      document.getElementById('ioQty').value = 1;
      openModal('ioModal');
    }

    function processIO(){
      const mode = document.getElementById('ioMode').value;      // import/export
      const src  = document.getElementById('ioSource').value;    // products/history
      const b = document.getElementById('ioBarcode').value.trim();
      const q = parseInt(document.getElementById('ioQty').value)||0;
      if(!b || q<=0) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      let p = products.find(x=>x.barcode===b);

      if(src === 'products'){
        // ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        if(!p){
          // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù†Ù†Ø´Ø¦Ù‡ØŒ Ø£Ù…Ø§ Ø§Ù„ØªØµØ¯ÙŠØ± Ù†Ù…Ù†Ø¹
          if(mode==='import'){
            products.push({barcode:b, price:0, stock:q});
          }else{
            return alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
          }
        }else{
          if(mode==='import'){ p.stock += q; }
          if(mode==='export'){
            if(p.stock<q) return alert("âŒ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„ØªØµØ¯ÙŠØ±");
            p.stock -= q;
          }
        }
      } // ÙÙŠ history Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†

      // Ù†Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø¯ÙˆÙ…Ø§Ù‹
      transactions.push({
        type: (mode==='import'?'Ø§Ø³ØªÙŠØ±Ø§Ø¯':'ØªØµØ¯ÙŠØ±'),
        barcode:b, qty:q, price:0, total:0, cost:0,
        date:new Date().toLocaleString()
      });

      saveData(); loadProducts(); loadHistory();
      closeModal('ioModal');
      alert("âœ” ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
    }

    /* ====== Modal helpers (Ù†Ø¸Ø§Ù…ÙŠ) ====== */
    function openModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.add('open'); m.setAttribute('aria-hidden','false');
      document.body.dataset.scrollLock = document.body.style.overflow || '';
      document.body.style.overflow='hidden';
    }
    function closeModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.remove('open'); m.setAttribute('aria-hidden','true');
      document.body.style.overflow = document.body.dataset.scrollLock || '';
      delete document.body.dataset.scrollLock;
    }
    function toggleModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.contains('open') ? closeModal(id) : openModal(id);
    }
    document.addEventListener('click',(e)=>{
      // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
      const modal = e.target.classList && e.target.classList.contains('modal') ? e.target : null;
      if(modal) closeModal(modal.id);
      // Ø£Ø²Ø±Ø§Ø± data-close
      if(e.target.matches('[data-close]')){
        const parentModal = e.target.closest('.modal');
        if(parentModal) closeModal(parentModal.id);
      }
    });
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        document.querySelectorAll('.modal.open').forEach(m=>closeModal(m.id));
      }
    });

    /* ====== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ====== */
    function startScanner(mode){
      scannerMode = mode;
      const scanner = document.getElementById("scanner");
      scanner.style.display="block";
      document.getElementById("lastScan").textContent="ğŸ“· Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...";
      try{ Quagga.stop(); }catch(e){}

      Quagga.init({
        inputStream:{ type:"LiveStream",
          constraints:{ facingMode:"environment", width:{ideal:1280}, height:{ideal:720} },
          target:scanner, area:{ top:"34%", right:"7%", left:"7%", bottom:"34%" }
        },
        decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader","upc_reader","code_39_reader","code_93_reader","i2of5_reader"] },
        locate:true
      }, err=>{ if(err){ console.error(err); alert("ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); return; } Quagga.start(); });

      Quagga.onDetected(d=>{
        let code=d.codeResult.code;
        document.getElementById("beep").play();
        document.getElementById("lastScan").textContent="âœ… Ø¢Ø®Ø± Ø¨Ø§Ø±ÙƒÙˆØ¯: "+code;

        if(scannerMode==="sell") document.getElementById("sellBarcode").value=code;
        if(scannerMode==="product") document.getElementById("pbarcode").value=code;
        if(scannerMode==="search"){ document.getElementById("searchInput").value=code; searchPage(); }
        if(scannerMode==="io"){ document.getElementById("ioBarcode").value=code; }

        Quagga.stop();
        scanner.style.display="none";
      });
    }

    /* ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ====== */
    loadProducts();
    </script>
</body>
</html>
