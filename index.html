<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>💰 نظام محاسبة المتجر</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family:"Cairo",sans-serif; margin:0; background:#0f172a; color:#e2e8f0; direction:rtl; font-size:18px; }
    header { background:#0b1223; color:#fff; padding:22px; text-align:center; font-size:26px; position:sticky; top:0; z-index:5; }
    nav { display:flex; justify-content:center; gap:14px; background:#111a33; padding:14px; flex-wrap:wrap; }
    nav button { background:#0ea5e9; border:none; color:white; padding:16px 26px; border-radius:12px; cursor:pointer; font-size:20px; font-weight:bold; }
    nav button:hover { background:#0284c7; }
    section { display:none; max-width:1000px; margin:24px auto; background:#0b1223; padding:22px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    section.active { display:block; }
    label { display:block; margin-top:12px; font-weight:700; font-size:18px; }
    input,button,select { margin:8px 0; padding:14px; border-radius:10px; border:1px solid #334155; width:100%; box-sizing:border-box; font-size:18px; background:#0f172a; color:#e2e8f0; }
    input::placeholder { color:#94a3b8; }
    button.action { background:#22c55e; color:white; border:none; width:100%; font-size:20px; font-weight:800; }
    button.action:hover { background:#16a34a; }
    .btn-sm { padding:10px 14px; font-size:16px; border-radius:10px; cursor:pointer; }
    .edit { background:#f59e0b; color:white; border:none; }
    .delete { background:#ef4444; color:white; border:none; }
    .neutral { background:#334155; color:#e2e8f0; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:16px; font-size:16px; }
    th,td { border:1px solid #1f2937; padding:10px; text-align:center; }
    th { background:#0f172a; }
    .searchBox{ margin:8px 0 14px; display:flex; gap:8px; flex-wrap:wrap; }
    .searchBox input{ flex:1; }

    /* ===== Scanner box ===== */
    #scanner { display:none; margin:15px auto; width:320px; height:320px; position:relative; border-radius:12px; overflow:hidden; background:#000; }
    .scan-box{ position:absolute; width:86%; height:32%; left:7%; top:34%; border:3px solid #00e5ff; border-radius:10px; pointer-events:none; }
    .scan-line{ position:absolute; left:8%; width:84%; height:2px; background:#ff3b3b; box-shadow:0 0 8px #ff3b3b,0 0 16px #ff3b3b; animation:sweep 1.3s linear infinite; }
    @keyframes sweep{ 0%{ top:36%; } 100%{ top:64%; } }
    #lastScan { text-align:center; font-size:18px; margin-top:8px; font-weight:bold; color:#93c5fd; }

    /* ===== Modal (نظامي) ===== */
    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:999;
    }
    .modal.open{ opacity:1; pointer-events:auto; }
    .modal__dialog{
      width:min(92vw, 420px); background:#0b1223; border:1px solid #1f2937;
      border-radius:14px; padding:20px; transform:translateY(10px) scale(.98);
      transition:transform .2s ease; box-shadow:0 16px 36px rgba(0,0,0,.35); text-align:center;
    }
    .modal.open .modal__dialog{ transform:translateY(0) scale(1); }
  </style>
</head>
<body>
  <header>💰 نظام محاسبة المتجر</header>

  <nav>
    <button onclick="showPage('sell')">💵 البيع</button>
    <button onclick="showPage('products')">🛒 المنتجات</button>
    <button onclick="showPage('profit')">📈 صافي الربح</button>
    <button onclick="showPage('history')">📊 السجل</button>
  </nav>

  <!-- صفحة البيع -->
  <section id="sell" class="active">
    <h2>💵 بيع منتج</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="🔍 ابحث بالباركود (خاصة بالمبيعات: يظهر المخزون فقط)">
      <button class="btn-sm neutral" onclick="startScanner('search')">📷 مسح</button>
      <button class="btn-sm neutral" onclick="searchPage()">🔎 بحث</button>
    </div>
    <div id="searchResult"></div>

    <label>📦 الباركود</label>
    <input id="sellBarcode" placeholder="ادخل الباركود">
    <button class="btn-sm neutral" onclick="startScanner('sell')">📷 مسح باركود</button>

    <button class="action" onclick="showSellModal()">✅ تنفيذ البيع</button>
  </section>

  <!-- صفحة المنتجات -->
  <section id="products">
    <h2>🛒 إدارة المنتجات</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="🔍 ابحث بالباركود (خاصة بالمنتجات: يظهر السعر+المخزون)">
      <button class="btn-sm neutral" onclick="startScanner('search')">📷 مسح</button>
      <button class="btn-sm neutral" onclick="searchPage()">🔎 بحث</button>
    </div>
    <div id="searchResult"></div>

    <label>💲 سعر التكلفة</label>
    <input id="pprice" type="number" placeholder="سعر التكلفة">

    <label>📦 الباركود</label>
    <input id="pbarcode" placeholder="الباركود">
    <button class="btn-sm neutral" onclick="startScanner('product')">📷 مسح باركود</button>

    <label>🔢 الكمية</label>
    <input id="pstock" type="number" placeholder="الكمية">

    <button class="action" onclick="addOrUpdateProduct()">➕ إضافة / تحديث</button>

    <!-- استيراد/تصدير (صفحة المنتجات تؤثر على المخزون) -->
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="openIO('import','products')">📦 استيراد</button>
      <button class="btn-sm" style="background:#f97316; color:#fff; border:none;" onclick="openIO('export','products')">📤 تصدير</button>
    </div>

    <h2 style="margin-top:18px;">📋 قائمة المنتجات</h2>
    <p>💰 القيمة الكلية للبضاعة: <span id="inventoryValue">0</span></p>

    <table id="productsTable">
      <thead><tr><th>الباركود</th><th>سعر التكلفة</th><th>المخزون</th><th>خيارات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- صفحة الربح (بدون بحث) -->
  <section id="profit">
    <h2>📈 صافي الربح</h2>
    <p>💵 إجمالي المبيعات: <span id="totalSales">0</span></p>
    <p>📦 إجمالي التكلفة: <span id="totalCost">0</span></p>
    <p>✅ صافي الربح: <span id="netProfit">0</span></p>
  </section>

  <!-- صفحة السجل -->
  <section id="history">
    <h2>📊 سجل العمليات</h2>

    <div class="searchBox">
      <input id="searchInput" placeholder="🔍 ابحث بالباركود (خاصة بالسجل: يعرض عمليات البيع/الاستيراد/التصدير)">
      <button class="btn-sm neutral" onclick="startScanner('search')">📷 مسح</button>
      <button class="btn-sm neutral" onclick="searchPage()">🔎 بحث</button>
    </div>
    <div id="searchResult"></div>

    <!-- استيراد/تصدير (صفحة السجل لا تغيّر المخزون، فقط تسجّل العملية) -->
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="openIO('import','history')">📦 استيراد</button>
      <button class="btn-sm" style="background:#f97316; color:#fff; border:none;" onclick="openIO('export','history')">📤 تصدير</button>
    </div>

    <table id="historyTable">
      <thead><tr><th>النوع</th><th>الباركود</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>التاريخ</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- نافذة البيع -->
  <div id="sellModal" class="modal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="sellTitle">
      <h3 id="sellTitle">تفاصيل المنتج 🛒</h3>
      <p id="sellInfo"></p>
      <label>💲 سعر البيع</label>
      <input id="modalSellPrice" type="number" placeholder="أدخل سعر البيع">
      <label>🔢 الكمية</label>
      <input id="modalSellQty" type="number" value="1">
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="confirmSale()">✅ تنفيذ البيع</button>
        <button class="btn-sm danger" data-close>❌ إغلاق</button>
      </div>
    </div>
  </div>

  <!-- نافذة الاستيراد/التصدير العامة -->
  <div id="ioModal" class="modal" aria-hidden="true">
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ioTitle">
      <h3 id="ioTitle">📦 عملية</h3>
      <input id="ioMode" type="hidden" value="import">
      <input id="ioSource" type="hidden" value="products">
      <label>📦 الباركود</label>
      <input id="ioBarcode" placeholder="ادخل الباركود">
      <button class="btn-sm neutral" onclick="startScanner('io')">📷 مسح</button>
      <label>🔢 الكمية</label>
      <input id="ioQty" type="number" value="1">
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-sm" style="background:#22c55e; color:#fff; border:none;" onclick="processIO()">✅ حفظ</button>
        <button class="btn-sm danger" data-close>❌ إغلاق</button>
      </div>
    </div>
  </div>

  <!-- الكاميرا -->
  <div id="scanner">
    <div class="scan-box"><div class="scan-line"></div></div>
  </div>
  <div id="lastScan"></div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    /* ====== بيانات ====== */
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
    let scannerMode = null;

    function saveData(){
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    /* ====== تحميل الجداول ====== */
    function loadProducts(){
      const tbody=document.querySelector("#productsTable tbody");
      tbody.innerHTML=""; let total=0;
      products.forEach(p=>{
        tbody.innerHTML += `<tr>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn-sm edit" onclick="editProduct('${p.barcode}')">✏️ تعديل</button>
            <button class="btn-sm delete" onclick="deleteProduct('${p.barcode}')">🗑️ حذف</button>
          </td>
        </tr>`;
        total += (Number(p.price)||0) * (Number(p.stock)||0);
      });
      document.getElementById("inventoryValue").textContent = total.toFixed(2);
    }

    function loadHistory(){
      const tbody=document.querySelector("#historyTable tbody");
      tbody.innerHTML="";
      transactions.forEach(t=>{
        tbody.innerHTML += `<tr>
          <td>${t.type}</td><td>${t.barcode}</td><td>${t.qty}</td>
          <td>${t.price}</td><td>${t.total}</td><td>${t.date}</td>
        </tr>`;
      });
    }

    /* ====== CRUD منتجات ====== */
    function addOrUpdateProduct(){
      const price=parseFloat(document.getElementById("pprice").value)||0;
      const barcode=document.getElementById("pbarcode").value.trim();
      const stock=parseInt(document.getElementById("pstock").value)||0;
      if(!barcode) return alert("❌ أدخل الباركود");

      let p=products.find(x=>x.barcode===barcode);
      if(p){ p.price = price || p.price; p.stock += stock; }
      else { products.push({barcode, price, stock}); }
      saveData(); loadProducts();
      alert("✔ تم الحفظ");
    }

    function editProduct(b){
      let p=products.find(x=>x.barcode===b);
      if(!p) return;
      document.getElementById("pbarcode").value=p.barcode;
      document.getElementById("pprice").value=p.price;
      document.getElementById("pstock").value=p.stock;
      showPage("products");
    }

    function deleteProduct(b){
      products = products.filter(p=>p.barcode!==b);
      saveData(); loadProducts();
    }

    /* ====== بيع ====== */
    function recordTransaction(b,q,pr){
      let p=products.find(x=>x.barcode===b)||{price:0};
      transactions.push({
        type:"بيع", barcode:b, qty:q,
        price:pr, total:pr*q, cost:(Number(p.price)||0)*q,
        date:new Date().toLocaleString()
      });
      saveData();
    }

    function showSellModal(){
      const b=document.getElementById("sellBarcode").value.trim();
      let p=products.find(x=>x.barcode===b);
      if(!p) return alert("❌ المنتج غير موجود");
      document.getElementById("sellInfo").innerHTML =
        `الباركود: ${p.barcode}<br>المخزون: ${p.stock}<br>التكلفة: ${p.price}`;
      openModal('sellModal');
    }

    function confirmSale(){
      const b=document.getElementById("sellBarcode").value.trim();
      const q=parseInt(document.getElementById("modalSellQty").value)||0;
      const pr=parseFloat(document.getElementById("modalSellPrice").value)||0;
      let p=products.find(x=>x.barcode===b);
      if(!p) return alert("❌ المنتج غير موجود");
      if(q<=0 || pr<0) return alert("❌ أدخل بيانات صحيحة");
      if(p.stock < q) return alert("❌ مخزون غير كافي");
      p.stock -= q;
      recordTransaction(b,q,pr);
      saveData(); loadProducts(); loadHistory();
      closeModal('sellModal');
      alert("✔ تمت عملية البيع");
    }

    /* ====== ربح ====== */
    function calcProfit(){
      let s=0,c=0;
      transactions.forEach(t=>{ s += (Number(t.price)||0) * (Number(t.qty)||0); c += (Number(t.cost)||0); });
      document.getElementById("totalSales").textContent=s.toFixed(2);
      document.getElementById("totalCost").textContent=c.toFixed(2);
      document.getElementById("netProfit").textContent=(s-c).toFixed(2);
    }

    /* ====== تنقل الصفحات ====== */
    function showPage(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(id==="products") loadProducts();
      if(id==="history") loadHistory();
      if(id==="profit") calcProfit();
      // تفريغ صندوق نتائج البحث عند تغيير الصفحة
      const sr = document.getElementById("searchResult");
      if(sr) sr.innerHTML = "";
    }

    /* ====== بحث (حسب الصفحة) ====== */
    function searchPage(){
      const input = document.getElementById("searchInput");
      if(!input) return;
      const code=input.value.trim(); if(!code) return;
      const active=document.querySelector("section.active").id;
      let res="";

      if(active==="sell"){
        const p=products.find(x=>x.barcode===code);
        res = p ? `المخزون المتاح: <b>${p.stock}</b> (أدخل سعر البيع يدوياً عند التنفيذ)` : "❌ المنتج غير موجود";
      }
      if(active==="products"){
        const p=products.find(x=>x.barcode===code);
        res = p ? `✅ موجود — الباركود: <b>${p.barcode}</b> • التكلفة: <b>${p.price}</b> • المخزون: <b>${p.stock}</b>` : "❌ غير موجود";
      }
      if(active==="history"){
        const logs=transactions.filter(t=>t.barcode===code);
        res = logs.length ? logs.map(t=>`${t.type} • كمية ${t.qty} • بتاريخ ${t.date}`).join("<br>") : "❌ لا يوجد عمليات";
      }
      document.getElementById("searchResult").innerHTML=res;
    }

    /* ====== استيراد/تصدير ====== */
    function openIO(mode, src){
      // mode: 'import' | 'export'  —  src: 'products' | 'history'
      document.getElementById('ioMode').value = mode;
      document.getElementById('ioSource').value = src;
      document.getElementById('ioTitle').textContent = (mode==='import'?'📦 استيراد':'📤 تصدير')
        + (src==='products'?' (تعديل مخزون)':' (تسجيل فقط)');
      document.getElementById('ioBarcode').value = '';
      document.getElementById('ioQty').value = 1;
      openModal('ioModal');
    }

    function processIO(){
      const mode = document.getElementById('ioMode').value;      // import/export
      const src  = document.getElementById('ioSource').value;    // products/history
      const b = document.getElementById('ioBarcode').value.trim();
      const q = parseInt(document.getElementById('ioQty').value)||0;
      if(!b || q<=0) return alert("❌ أدخل البيانات");

      let p = products.find(x=>x.barcode===b);

      if(src === 'products'){
        // يؤثر على المخزون
        if(!p){
          // عند الاستيراد لو غير موجود ننشئه، أما التصدير نمنع
          if(mode==='import'){
            products.push({barcode:b, price:0, stock:q});
          }else{
            return alert("❌ لا يمكن التصدير لمنتج غير موجود");
          }
        }else{
          if(mode==='import'){ p.stock += q; }
          if(mode==='export'){
            if(p.stock<q) return alert("❌ مخزون غير كافي للتصدير");
            p.stock -= q;
          }
        }
      } // في history لا نغيّر المخزون

      // نسجّل العملية في السجل دوماً
      transactions.push({
        type: (mode==='import'?'استيراد':'تصدير'),
        barcode:b, qty:q, price:0, total:0, cost:0,
        date:new Date().toLocaleString()
      });

      saveData(); loadProducts(); loadHistory();
      closeModal('ioModal');
      alert("✔ تمت العملية");
    }

    /* ====== Modal helpers (نظامي) ====== */
    function openModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.add('open'); m.setAttribute('aria-hidden','false');
      document.body.dataset.scrollLock = document.body.style.overflow || '';
      document.body.style.overflow='hidden';
    }
    function closeModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.remove('open'); m.setAttribute('aria-hidden','true');
      document.body.style.overflow = document.body.dataset.scrollLock || '';
      delete document.body.dataset.scrollLock;
    }
    function toggleModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.contains('open') ? closeModal(id) : openModal(id);
    }
    document.addEventListener('click',(e)=>{
      // إغلاق بالضغط خارج الصندوق
      const modal = e.target.classList && e.target.classList.contains('modal') ? e.target : null;
      if(modal) closeModal(modal.id);
      // أزرار data-close
      if(e.target.matches('[data-close]')){
        const parentModal = e.target.closest('.modal');
        if(parentModal) closeModal(parentModal.id);
      }
    });
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        document.querySelectorAll('.modal.open').forEach(m=>closeModal(m.id));
      }
    });

    /* ====== الكاميرا/الباركود ====== */
    function startScanner(mode){
      scannerMode = mode;
      const scanner = document.getElementById("scanner");
      scanner.style.display="block";
      document.getElementById("lastScan").textContent="📷 جاري المسح...";
      try{ Quagga.stop(); }catch(e){}

      Quagga.init({
        inputStream:{ type:"LiveStream",
          constraints:{ facingMode:"environment", width:{ideal:1280}, height:{ideal:720} },
          target:scanner, area:{ top:"34%", right:"7%", left:"7%", bottom:"34%" }
        },
        decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader","upc_reader","code_39_reader","code_93_reader","i2of5_reader"] },
        locate:true
      }, err=>{ if(err){ console.error(err); alert("تعذّر فتح الكاميرا"); return; } Quagga.start(); });

      Quagga.onDetected(d=>{
        let code=d.codeResult.code;
        document.getElementById("beep").play();
        document.getElementById("lastScan").textContent="✅ آخر باركود: "+code;

        if(scannerMode==="sell") document.getElementById("sellBarcode").value=code;
        if(scannerMode==="product") document.getElementById("pbarcode").value=code;
        if(scannerMode==="search"){ document.getElementById("searchInput").value=code; searchPage(); }
        if(scannerMode==="io"){ document.getElementById("ioBarcode").value=code; }

        Quagga.stop();
        scanner.style.display="none";
      });
    }

    /* ====== تشغيل أولي ====== */
    loadProducts();
    </script>
</body>
</html>
